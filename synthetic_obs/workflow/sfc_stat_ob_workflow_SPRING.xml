<?xml version="1.0" encoding="UTF-8"?>

<!--
Workflow To Create Perfect Simulated Obs

This workflow assumes that the directory tree is configured in the following way:
    1. WRF_DIR contains separate subdirectories for each day with the following naming
       convention: YYYYMMDD
    2. OUT_DIR contains the following subdirectories: "conv", "adpupa", "perfect", and
       "log" 

shawn.s.murdzek@noaa.gov
-->

<!DOCTYPE workflow [

<!--
Parameters needed by the job scheduler.
-->
<!ENTITY ACCOUNT         "wrfruc">
<!ENTITY SCHED           "slurm">
<!ENTITY QUEUE_DEFAULT   "batch">
<!ENTITY PARTITION       "orion">

<!--
Workflow task names.
-->
<!ENTITY PERFECT_OBS_TN  "perfect_obs">
<!ENTITY TAG             "OB_WORKFLOW">

<!--
Directories and environment variables
-->
<!ENTITY HOME            "/work2/noaa/wrfruc/murdzek">
<!ENTITY PY_ENV          "&HOME;/src/nature_run_wflow/env">
<!ENTITY CODE_DIR        "&HOME;/src/py_scripts/synthetic_obs">
<!ENTITY WFLOW_DIR       "&HOME;/src/py_scripts/synthetic_obs/workflow">
<!ENTITY WRF_DIR         "&HOME;/nature_run_spring/UPP">
<!ENTITY BUFR_DIR        "&HOME;/real_obs/sfc_stations/bufr_csv">
<!ENTITY OUT_DIR         "&HOME;/nature_run_spring/sfc_stat_obs_csv">
<!ENTITY PERF_OB_SCRIPT  "&WFLOW_DIR;/create_sfc_stat_obs.sh">
<!ENTITY start_UPP       "2022042912">
<!ENTITY end_UPP         "2022050611">
<!ENTITY MACHINE         "ORION">

<!--
Number of cores for each task
-->
<!ENTITY PERFECT_OB_CORES  "1">

<!--
Reservation types.  Reservations specify the queue/partition and account
to use for a given task.
-->
<!ENTITY RSRV_DEFAULT "<account>&ACCOUNT;</account><queue>&QUEUE_DEFAULT;</queue><partition>&PARTITION;</partition>">


]>
<workflow realtime="F" scheduler="&SCHED;" cyclethrottle="20" cyclelifespan="30:00:00:00">


  <cycledef group="create_obs"> 202204291200 202205061100 01:00:00 </cycledef>

  <log>
    <cyclestr>&WFLOW_DIR;/SFC_STAT_OB_wflow_SPRING.log</cyclestr>
  </log>



<!--
************************************************************************
************************************************************************
-->
  <task name="&PERFECT_OBS_TN;" cycledefs="create_obs" maxtries="3">

    &RSRV_DEFAULT;
  
    <command>&PERF_OB_SCRIPT;</command>
  
    <cores>&PERFECT_OB_CORES;</cores>
    <walltime>08:00:00</walltime>
    <memory>25G</memory>
    <jobname>&TAG;_&PERFECT_OBS_TN;</jobname>
    <join><cyclestr>&OUT_DIR;/log/&PERFECT_OBS_TN;_@Y@m@d@H@M.log</cyclestr></join>
    
    <envar><name>MACHINE</name><value>&MACHINE;</value></envar>
    <envar><name>PY_ENV</name><value>&PY_ENV;</value></envar>
    <envar><name>CODE_DIR</name><value>&CODE_DIR;</value></envar>
    <envar><name>WRF_DIR</name><value>&WRF_DIR;</value></envar>
    <envar><name>BUFR_DIR</name><value>&BUFR_DIR;</value></envar>
    <envar><name>OUT_DIR</name><value>&OUT_DIR;</value></envar>
    <envar><name>cycle</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>start_UPP</name><value>&start_UPP;</value></envar>
    <envar><name>end_UPP</name><value>&end_UPP;</value></envar>

  </task>
</workflow>
