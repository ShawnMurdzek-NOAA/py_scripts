<?xml version="1.0" encoding="UTF-8"?>

<!--
Workflow To Create Perfect Simulated Obs

shawn.s.murdzek@noaa.gov
-->

<!DOCTYPE workflow [

<!--
Parameters needed by the job scheduler.
-->
<!ENTITY ACCOUNT         "wrfruc">
<!ENTITY SCHED           "slurm">
<!ENTITY QUEUE_DEFAULT   "batch">

<!--
Workflow task names.
-->
<!ENTITY PERFECT_OBS_TN  "perfect_obs">
<!ENTITY TAG             "OB_WORKFLOW">

<!--
Directories and environment variables
-->
<!ENTITY HOME            "/work2/noaa/wrfruc/murdzek">
<!ENTITY PY_ENV          "&HOME;/src/nature_run_wflow/env">
<!ENTITY CODE_DIR        "&HOME;/src/py_scripts/synthetic_obs"
<!ENTITY PERF_OB_SCRIPT  "&CODE_DIR;/create_perfect_obs.sh">
<!ENTITY first_UPP       "2022042912">
<!ENTITY last_UPP        "2022050612">
<!ENTITY MACHINE         "ORION">

<!--
Number of cores for each task
-->
<!ENTITY PERFECT_OB_CORES  "1">

<!--
Reservation types.  Reservations specify the queue/partition and account
to use for a given task.
-->
<!ENTITY RSRV_DEFAULT "<account>&ACCOUNT;</account><queue>&QUEUE_DEFAULT;</queue>">


]>
<workflow realtime="F" scheduler="&SCHED;" cyclethrottle="20" cyclelifespan="30:00:00:00">


  <cycledef group="create_obs"> 202204291200 202205061200 01:00:00 </cycledef>

  <log>
    <cyclestr>&CODEDIR;/NATURE_RUN_wflow.log</cyclestr>
  </log>



<!--
************************************************************************
************************************************************************
-->
  <task name="&PERFECT_OBS_TN;" cycledefs="create_obs" maxtries="3">

    &RSRV_DEFAULT;
  
    <command>&PERF_OB_SCRIPT;</command>
  
    <cores>&PERFECT_OB_CORES;</cores>
    <walltime>04:00:00</walltime>
    <memory>25G</memory>
    <jobname>&TAG;_&PERFECT_OBS_TN;</jobname>
    <join><cyclestr>&RESTARTDIR;/GEOGRID/&GEOGRID_TN;_@Y@m@d@H@M.log</cyclestr></join>
    
    <envar><name>MACHINE</name><value>&MACHINE;</value></envar>
    <envar><name>PY_ENV</name><value>&PY_ENV;</value></envar>
    <envar><name>cycle</name><value><cyclestr>@Y@m@d@H</cyclestr></value></envar>
    <envar><name>first_UPP</name><value>&first_UPP;</value></envar>
    <envar><name>last_UPP</name><value>&last_UPP;</value></envar>

  </task>
</workflow>
